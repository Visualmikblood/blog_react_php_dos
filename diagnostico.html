<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico Completo - Blog React PHP</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        h2 {
            color: #555;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
            margin-top: 30px;
        }
        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }

        .test-section {
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            background: #f8f9fa;
        }
        .test-button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: all 0.3s ease;
        }
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .test-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        .credentials {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
        }

        .credentials h3 {
            margin: 0 0 10px 0;
            font-size: 1.5em;
        }

        .credentials p {
            margin: 5px 0;
            font-size: 1.2em;
            font-weight: bold;
        }

        .server-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .server-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .server-card.running {
            border-color: #28a745;
            background: #d4edda;
        }

        .server-card.stopped {
            border-color: #dc3545;
            background: #f8d7da;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }

        .summary {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-top: 30px;
        }

        .summary h3 {
            margin: 0 0 10px 0;
            font-size: 1.8em;
        }

        .summary p {
            margin: 5px 0;
            font-size: 1.1em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç DIAGN√ìSTICO COMPLETO</h1>
        <p style="text-align: center; color: #666; margin-bottom: 30px;">
            Herramienta para verificar el estado completo del sistema Blog React PHP
        </p>

        <!-- Credenciales -->
        <div class="credentials">
            <h3>üîê CREDENCIALES DE ACCESO</h3>
            <p>üìß Email: <strong>admin@blog.com</strong></p>
            <p>üîë Contrase√±a: <strong>password</strong></p>
        </div>

        <!-- Estado de servidores -->
        <h2>üñ•Ô∏è ESTADO DE SERVIDORES</h2>
        <div class="server-status">
            <div class="server-card" id="php-server">
                <h3>üêò Servidor PHP</h3>
                <p>localhost:8000</p>
                <div class="status info">Verificando...</div>
            </div>
            <div class="server-card" id="react-server">
                <h3>‚öõÔ∏è Servidor React</h3>
                <p>localhost:5173</p>
                <div class="status info">Verificando...</div>
            </div>
        </div>

        <!-- Pruebas individuales -->
        <h2>üß™ PRUEBAS INDIVIDUALES</h2>

        <div class="test-section">
            <h3>1Ô∏è‚É£ Prueba de Login</h3>
            <button class="test-button" onclick="testLogin()">üöÄ Probar Login</button>
            <div class="result" id="login-result">Haz clic en "Probar Login" para comenzar...</div>
        </div>

        <div class="test-section">
            <h3>2Ô∏è‚É£ Prueba de Token</h3>
            <button class="test-button" onclick="testToken()">üé´ Probar Token</button>
            <div class="result" id="token-result">Primero realiza el login para obtener un token...</div>
        </div>

        <div class="test-section">
            <h3>3Ô∏è‚É£ Prueba de Categor√≠as</h3>
            <button class="test-button" onclick="testCategories()">üìÅ Probar Categor√≠as</button>
            <div class="result" id="categories-result">Requiere token de autenticaci√≥n...</div>
        </div>

        <div class="test-section">
            <h3>4Ô∏è‚É£ Prueba de Art√≠culos</h3>
            <button class="test-button" onclick="testPosts()">üìù Probar Art√≠culos</button>
            <div class="result" id="posts-result">Requiere token de autenticaci√≥n...</div>
        </div>

        <div class="test-section">
            <h3>5Ô∏è‚É£ Prueba Completa del Sistema</h3>
            <button class="test-button" onclick="runFullTest()">üéØ Ejecutar Prueba Completa</button>
            <div class="result" id="full-test-result">Esta prueba ejecuta todas las funcionalidades autom√°ticamente...</div>
        </div>

        <!-- Barra de progreso -->
        <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
        </div>

        <!-- Resumen final -->
        <div class="summary" id="final-summary" style="display: none;">
            <h3>üìä RESULTADO FINAL</h3>
            <p id="summary-text">Ejecuta las pruebas para ver el resultado...</p>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8000';
        let authToken = null;
        let testResults = {
            login: false,
            token: false,
            categories: false,
            posts: false
        };

        // Verificar estado de servidores al cargar
        window.onload = function() {
            checkServers();
        };

        async function checkServers() {
            // Verificar servidor PHP
            try {
                const response = await fetch(`${API_BASE_URL}/admin/auth/auth.php`, {
                    method: 'OPTIONS'
                });
                document.getElementById('php-server').className = 'server-card running';
                document.getElementById('php-server').querySelector('.status').textContent = '‚úÖ Ejecut√°ndose';
                document.getElementById('php-server').querySelector('.status').className = 'status success';
            } catch (error) {
                document.getElementById('php-server').className = 'server-card stopped';
                document.getElementById('php-server').querySelector('.status').textContent = '‚ùå Detenido';
                document.getElementById('php-server').querySelector('.status').className = 'status error';
            }

            // Verificar servidor React (este mismo servidor)
            document.getElementById('react-server').className = 'server-card running';
            document.getElementById('react-server').querySelector('.status').textContent = '‚úÖ Ejecut√°ndose';
            document.getElementById('react-server').querySelector('.status').className = 'status success';
        }

        async function testLogin() {
            const resultDiv = document.getElementById('login-result');
            const button = event.target;
            button.disabled = true;
            button.textContent = '‚è≥ Probando...';

            try {
                console.log('üîÑ Enviando petici√≥n de login...');
                const response = await fetch(`${API_BASE_URL}/admin/auth/auth.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'login',
                        email: 'admin@blog.com',
                        password: 'password'
                    })
                });

                const data = await response.json();
                console.log('üì¶ Respuesta:', data);

                if (response.ok && data.token) {
                    authToken = data.token;
                    testResults.login = true;
                    resultDiv.innerHTML = `
‚úÖ <strong>LOGIN EXITOSO</strong>
üìß Usuario: ${data.user.name}
üîë Email: ${data.user.email}
üë§ Rol: ${data.user.role}
üé´ Token generado correctamente
üíæ Token guardado para pr√≥ximas pruebas
                    `;
                    resultDiv.className = 'result success';
                } else {
                    resultDiv.innerHTML = `
‚ùå <strong>ERROR EN LOGIN</strong>
üìä Status: ${response.status}
üí¨ Mensaje: ${data.message || 'Error desconocido'}
                    `;
                    resultDiv.className = 'result error';
                }
            } catch (error) {
                console.error('üí• Error:', error);
                resultDiv.innerHTML = `
üí• <strong>ERROR DE CONEXI√ìN</strong>
üí¨ Error: ${error.message}
üîç Verifica que el servidor PHP est√© ejecut√°ndose en localhost:8000
                `;
                resultDiv.className = 'result error';
            } finally {
                button.disabled = false;
                button.textContent = 'üöÄ Probar Login';
                updateProgress();
            }
        }

        async function testToken() {
            if (!authToken) {
                document.getElementById('token-result').innerHTML = '‚ùå <strong>ERROR:</strong> Primero debes hacer login para obtener un token';
                document.getElementById('token-result').className = 'result error';
                return;
            }

            const resultDiv = document.getElementById('token-result');
            const button = event.target;
            button.disabled = true;
            button.textContent = '‚è≥ Probando...';

            try {
                const response = await fetch(`${API_BASE_URL}/admin/auth/auth.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'verify',
                        token: authToken
                    })
                });

                const data = await response.json();

                if (response.ok && data.valid) {
                    testResults.token = true;
                    resultDiv.innerHTML = `
‚úÖ <strong>TOKEN V√ÅLIDO</strong>
üë§ Usuario: ${data.user.name}
üîë Email: ${data.user.email}
üë§ Rol: ${data.user.role}
‚è∞ Token activo y funcionando correctamente
                    `;
                    resultDiv.className = 'result success';
                } else {
                    resultDiv.innerHTML = `
‚ùå <strong>TOKEN INV√ÅLIDO</strong>
üìä Status: ${response.status}
üí¨ Mensaje: ${data.message || 'Token expirado o inv√°lido'}
                    `;
                    resultDiv.className = 'result error';
                }
            } catch (error) {
                resultDiv.innerHTML = `üí• <strong>ERROR:</strong> ${error.message}`;
                resultDiv.className = 'result error';
            } finally {
                button.disabled = false;
                button.textContent = 'üé´ Probar Token';
                updateProgress();
            }
        }

        async function testCategories() {
            if (!authToken) {
                document.getElementById('categories-result').innerHTML = '‚ùå <strong>ERROR:</strong> Necesitas autenticarte primero';
                document.getElementById('categories-result').className = 'result error';
                return;
            }

            const resultDiv = document.getElementById('categories-result');
            const button = event.target;
            button.disabled = true;
            button.textContent = '‚è≥ Probando...';

            try {
                // Crear categor√≠a de prueba
                const createResponse = await fetch(`${API_BASE_URL}/admin/categories/manage.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        name: 'Categor√≠a de Prueba',
                        slug: 'categoria-prueba',
                        description: 'Categor√≠a creada desde el diagn√≥stico'
                    })
                });

                const createData = await createResponse.json();

                if (createResponse.ok) {
                    testResults.categories = true;
                    resultDiv.innerHTML = `
‚úÖ <strong>CATEGOR√çA CREADA EXITOSAMENTE</strong>
üìÅ Nombre: ${createData.category?.name || 'Categor√≠a de Prueba'}
üÜî ID: ${createData.category_id || 'N/A'}
üìù Descripci√≥n: ${createData.category?.description || 'Categor√≠a creada desde el diagn√≥stico'}
üîÑ Estado: Operativo
                    `;
                    resultDiv.className = 'result success';
                } else {
                    resultDiv.innerHTML = `
‚ùå <strong>ERROR AL CREAR CATEGOR√çA</strong>
üìä Status: ${createResponse.status}
üí¨ Mensaje: ${createData.message || 'Error desconocido'}
                    `;
                    resultDiv.className = 'result error';
                }
            } catch (error) {
                resultDiv.innerHTML = `üí• <strong>ERROR:</strong> ${error.message}`;
                resultDiv.className = 'result error';
            } finally {
                button.disabled = false;
                button.textContent = 'üìÅ Probar Categor√≠as';
                updateProgress();
            }
        }

        async function testPosts() {
            if (!authToken) {
                document.getElementById('posts-result').innerHTML = '‚ùå <strong>ERROR:</strong> Necesitas autenticarte primero';
                document.getElementById('posts-result').className = 'result error';
                return;
            }

            const resultDiv = document.getElementById('posts-result');
            const button = event.target;
            button.disabled = true;
            button.textContent = '‚è≥ Probando...';

            try {
                // Crear art√≠culo de prueba
                const createResponse = await fetch(`${API_BASE_URL}/admin/posts/create.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        title: 'Art√≠culo de Prueba',
                        content: 'Este es un art√≠culo creado autom√°ticamente desde el diagn√≥stico del sistema.',
                        excerpt: 'Resumen del art√≠culo de prueba',
                        category_id: 1,
                        status: 'draft'
                    })
                });

                const createData = await createResponse.json();

                if (createResponse.ok) {
                    testResults.posts = true;
                    resultDiv.innerHTML = `
‚úÖ <strong>ART√çCULO CREADO EXITOSAMENTE</strong>
üìù T√≠tulo: ${createData.post?.title || 'Art√≠culo de Prueba'}
üÜî ID: ${createData.post_id || 'N/A'}
üìÑ Contenido: ${createData.post?.content?.substring(0, 50) || 'Contenido de prueba'}...
üìä Estado: ${createData.post?.status || 'draft'}
üîÑ Estado: Operativo
                    `;
                    resultDiv.className = 'result success';
                } else {
                    resultDiv.innerHTML = `
‚ùå <strong>ERROR AL CREAR ART√çCULO</strong>
üìä Status: ${createResponse.status}
üí¨ Mensaje: ${createData.message || 'Error desconocido'}
                    `;
                    resultDiv.className = 'result error';
                }
            } catch (error) {
                resultDiv.innerHTML = `üí• <strong>ERROR:</strong> ${error.message}`;
                resultDiv.className = 'result error';
            } finally {
                button.disabled = false;
                button.textContent = 'üìù Probar Art√≠culos';
                updateProgress();
            }
        }

        async function runFullTest() {
            const resultDiv = document.getElementById('full-test-result');
            const button = event.target;
            button.disabled = true;
            button.textContent = '‚è≥ Ejecutando...';

            resultDiv.innerHTML = 'üöÄ <strong>INICIANDO PRUEBA COMPLETA</strong>\n\n';

            try {
                // Paso 1: Login
                resultDiv.innerHTML += '1Ô∏è‚É£ Probando login...\n';
                const loginResponse = await fetch(`${API_BASE_URL}/admin/auth/auth.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'login',
                        email: 'admin@blog.com',
                        password: 'password'
                    })
                });

                const loginData = await loginResponse.json();
                if (!loginResponse.ok || !loginData.token) {
                    throw new Error('Login fall√≥: ' + (loginData.message || 'Error desconocido'));
                }

                authToken = loginData.token;
                resultDiv.innerHTML += '‚úÖ Login exitoso\n';

                // Paso 2: Verificar token
                resultDiv.innerHTML += '2Ô∏è‚É£ Verificando token...\n';
                const tokenResponse = await fetch(`${API_BASE_URL}/admin/auth/auth.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'verify',
                        token: authToken
                    })
                });

                const tokenData = await tokenResponse.json();
                if (!tokenResponse.ok || !tokenData.valid) {
                    throw new Error('Token inv√°lido');
                }
                resultDiv.innerHTML += '‚úÖ Token v√°lido\n';

                // Paso 3: Crear categor√≠a
                resultDiv.innerHTML += '3Ô∏è‚É£ Creando categor√≠a...\n';
                const categoryResponse = await fetch(`${API_BASE_URL}/admin/categories/manage.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        name: 'Test Diagn√≥stico',
                        slug: 'test-diagnostico',
                        description: 'Categor√≠a creada por diagn√≥stico autom√°tico'
                    })
                });

                const categoryData = await categoryResponse.json();
                if (!categoryResponse.ok) {
                    throw new Error('Error al crear categor√≠a: ' + (categoryData.message || 'Error desconocido'));
                }
                resultDiv.innerHTML += '‚úÖ Categor√≠a creada\n';

                // Paso 4: Crear art√≠culo
                resultDiv.innerHTML += '4Ô∏è‚É£ Creando art√≠culo...\n';
                const postResponse = await fetch(`${API_BASE_URL}/admin/posts/create.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        title: 'Diagn√≥stico Autom√°tico',
                        content: 'Este art√≠culo fue creado autom√°ticamente por el sistema de diagn√≥stico.',
                        excerpt: 'Art√≠culo generado por el diagn√≥stico del sistema',
                        category_id: 1,
                        status: 'published'
                    })
                });

                const postData = await postResponse.json();
                if (!postResponse.ok) {
                    throw new Error('Error al crear art√≠culo: ' + (postData.message || 'Error desconocido'));
                }
                resultDiv.innerHTML += '‚úÖ Art√≠culo creado\n\n';

                // Resultado final
                resultDiv.innerHTML += 'üéâ <strong>PRUEBA COMPLETA EXITOSA</strong>\n';
                resultDiv.innerHTML += '‚úÖ Login funcionando\n';
                resultDiv.innerHTML += '‚úÖ Token funcionando\n';
                resultDiv.innerHTML += '‚úÖ Categor√≠as funcionando\n';
                resultDiv.innerHTML += '‚úÖ Art√≠culos funcionando\n\n';
                resultDiv.innerHTML += '<strong>üìä SISTEMA OPERATIVO AL 100%</strong>';

                resultDiv.className = 'result success';

                // Actualizar resultados
                testResults.login = true;
                testResults.token = true;
                testResults.categories = true;
                testResults.posts = true;
                updateProgress();

                // Mostrar resumen final
                showFinalSummary(true);

            } catch (error) {
                resultDiv.innerHTML += `\n‚ùå <strong>ERROR EN PRUEBA COMPLETA:</strong> ${error.message}`;
                resultDiv.className = 'result error';
                showFinalSummary(false, error.message);
            } finally {
                button.disabled = false;
                button.textContent = 'üéØ Ejecutar Prueba Completa';
            }
        }

        function updateProgress() {
            const completed = Object.values(testResults).filter(Boolean).length;
            const total = Object.keys(testResults).length;
            const percentage = (completed / total) * 100;

            document.getElementById('progress-fill').style.width = percentage + '%';
        }

        function showFinalSummary(success, errorMessage = '') {
            const summaryDiv = document.getElementById('final-summary');
            const summaryText = document.getElementById('summary-text');

            summaryDiv.style.display = 'block';

            if (success) {
                summaryDiv.className = 'summary';
                summaryText.innerHTML = `
                    <strong>‚úÖ SISTEMA FUNCIONANDO PERFECTAMENTE</strong><br>
                    üéØ Todas las pruebas pasaron exitosamente<br>
                    üîê Login operativo<br>
                    üé´ Token JWT funcionando<br>
                    üìÅ Categor√≠as operativas<br>
                    üìù Art√≠culos operativos<br>
                    <br>
                    <strong>üöÄ El sistema est√° listo para usar</strong>
                `;
            } else {
                summaryDiv.className = 'summary';
                summaryDiv.style.background = 'linear-gradient(45deg, #dc3545, #c82333)';
                summaryText.innerHTML = `
                    <strong>‚ùå SISTEMA CON PROBLEMAS</strong><br>
                    üí• Error detectado: ${errorMessage}<br>
                    üîç Revisa los logs del servidor<br>
                    üõ†Ô∏è Verifica que ambos servidores est√©n ejecut√°ndose<br>
                    üìû Contacta soporte si el problema persiste
                `;
            }
        }

        // Funci√≥n para limpiar resultados
        function clearResults() {
            document.querySelectorAll('.result').forEach(div => {
                div.innerHTML = 'Resultado aparecer√° aqu√≠...';
                div.className = 'result';
            });
            authToken = null;
            testResults = { login: false, token: false, categories: false, posts: false };
            document.getElementById('progress-fill').style.width = '0%';
            document.getElementById('final-summary').style.display = 'none';
        }

        // Agregar bot√≥n de limpiar
        setTimeout(() => {
            const clearButton = document.createElement('button');
            clearButton.className = 'test-button';
            clearButton.textContent = 'üßπ Limpiar Resultados';
            clearButton.onclick = clearResults;
            document.querySelector('.container').appendChild(clearButton);
        }, 1000);
    </script>
</body>
</html>